generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * AUTH / USERS
 * =========================
 */
enum Role {
  ADMIN
  SUPPORT
  CUSTOMER
}

// üîî Notificaciones
enum NotificationType {
  ORDER_CREATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  PAYMENT_FAILED
  ACCOUNT_PASSWORD_CHANGED
  ACCOUNT_EMAIL_CHANGED
  NEW_LOGIN
  WISHLIST_ITEM_ON_SALE
  WISHLIST_ITEM_BACK_IN_STOCK
  PROMOTION_COUPON
  SUPPORT_MESSAGE_REPLY
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
}

model User {
  id    String @id @default(cuid())
  email String @unique

  // Nombre completo legacy (se mantiene por compatibilidad)
  name String?

  // NUEVOS: nombre estructurado
  firstName  String?
  middleName String?
  lastName   String?

  // NUEVO: documento de identidad
  ci String? @db.VarChar(64)

  // Tel√©fono en E.164 (+ y hasta 15 d√≠gitos) ‚Üí 16 con el '+'
  phone String? @db.VarChar(16)

  avatarUrl        String?
  avatarPublicId   String?
  emailVerifiedAt  DateTime?
  passwordHash     String
  role             Role           @default(CUSTOMER)
  twoFactorEnabled Boolean        @default(false)
  twoFactorSecret  String?
  refreshTokens    RefreshToken[]
  orders           Order[]

  // Relaci√≥n 1-N de direcciones (propietario)
  addresses Address[] @relation("UserAddresses")

  // Direcciones por defecto (1-1 a Address con nombres de relaci√≥n distintos)
  defaultShippingAddressId String?
  defaultBillingAddressId  String?

  defaultShippingAddress Address? @relation("UserDefaultShipping", fields: [defaultShippingAddressId], references: [id], onDelete: SetNull)
  defaultBillingAddress  Address? @relation("UserDefaultBilling", fields: [defaultBillingAddressId], references: [id], onDelete: SetNull)

  reviews ProductReview[]

  // üî• Wishlist / favoritos
  wishlistItems WishlistItem[]

  // üîî Notificaciones
  notifications          Notification[]
  notificationPreference NotificationPreference?

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Soporte (relaciones inversas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Conversaciones donde el usuario es el cliente
  conversations Conversation[] @relation("ConversationUser")
  // Conversaciones asignadas a este usuario como agente
  assigned      Conversation[] @relation("AssignedAgent")
  // Mensajes enviados por este usuario (cliente o agente)
  messages      Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([createdAt])
  @@index([phone])
  @@index([ci])
}

model RefreshToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  token     String   @unique
  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, revoked])
  @@index([expiresAt])
}

// üîî NOTIFICATIONS
model Notification {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  type    NotificationType
  channel NotificationChannel @default(IN_APP)

  title String
  body  String
  data  Json?

  isRead   Boolean  @default(false)
  readAt   DateTime?
  archived Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, archived, isRead, createdAt(sort: Desc)])
  @@index([userId, createdAt])
}

model NotificationPreference {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Email
  emailOrderUpdates    Boolean @default(true)
  emailSecurityAlerts  Boolean @default(true)
  emailPromotions      Boolean @default(false)

  // In-app
  inAppOrderUpdates    Boolean @default(true)
  inAppSecurityAlerts  Boolean @default(true)
  inAppPromotions      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * ADDRESS (reutilizable)
 * =========================
 */
model Address {
  id String @id @default(cuid())

  // Due√±o (User 1-N)
  user   User?   @relation("UserAddresses", fields: [userId], references: [id], onDelete: SetNull)
  userId String?

  label         String? // "Casa", "Oficina", etc.
  recipientName String
  phone         String?
  addressLine1  String
  addressLine2  String?
  city          String
  state         String?
  postalCode    String
  country       String

  // üåç Geolocalizaci√≥n / mapa
  lat         Float?
  lng         Float?
  mapLabel    String? // texto bonito de la ubicaci√≥n
  geoProvider String? // p.ej. "geoapify"
  geoPlaceId  String? // id del proveedor

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isDefaultShipping Boolean @default(false)
  isDefaultBilling  Boolean @default(false)

  // Back-rels 1-1 desde User
  usersDefaultShipping User[] @relation("UserDefaultShipping")
  usersDefaultBilling  User[] @relation("UserDefaultBilling")

  @@index([userId])
}

/**
 * =========================
 * CATEGORIES (jerarqu√≠a)
 * =========================
 */
model Category {
  id   String @id @default(cuid())
  name String
  slug String @unique

  parentId String?
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  children Category[] @relation("CategoryToCategory")

  products Product[]

  // Imagen opcional (subida por admin)
  imageUrl      String?
  imagePublicId String?

  couponsApplied Coupon[] @relation("CouponCategoryApplies")

  @@index([parentId])
}

/**
 * =========================
 * PRODUCTS
 * =========================
 */

enum ProductCondition {
  NEW
  USED
  REFURBISHED
}

// Detalle de condici√≥n (para productos usados/reacondicionados)
enum ConditionGrade {
  LIKE_NEW   // Como nuevo
  VERY_GOOD  // Muy bueno
  GOOD       // Bueno
  ACCEPTABLE // Aceptable
}

model Product {
  id          String  @id @default(cuid())
  slug        String  @unique
  sku         String? @unique
  name        String
  description String
  price       Int    // centavos (>= 0 en app)
  currency    String @default("usd")
  stock       Int    @default(0)
  active      Boolean @default(true)

  // Marca como texto libre (para filtros por marca haremos groupBy sobre este campo)
  brand String?

  // üîπ NUEVOS CAMPOS PARA FILTROS AVANZADOS
  /// Tipo l√≥gico de producto dentro de la categor√≠a
  /// Ej: "moto_electrica", "refrigerador", "detergente_liquido"
  productType String? @db.VarChar(64)

  /// Nombre de modelo comercial. Ej: "Yoazaky 707"
  modelName String? @db.VarChar(128)

  /// Tags libres para filtros (ej: ["electrico","urbano","adulto"])
  tags String[] @db.Text

  barcode     String? @unique
  weightGrams Int?
  widthMm     Int?
  heightMm    Int?
  lengthMm    Int?

  // Condici√≥n tipo Amazon: nuevo / usado / reacondicionado (b√°sico)
  condition ProductCondition @default(NEW)

  // Detalle de condici√≥n
  conditionGrade ConditionGrade?
  conditionNote  String? // "Con leves marcas de uso en la parte trasera"

  // Atributos visuales / variantes
  mainColor     String? @db.VarChar(32) // Color principal para filtros
  colorVariants Json? // Lista de colores / variantes

  // Env√≠o / entrega
  homeDeliveryAvailable Boolean @default(true)  // Env√≠o a domicilio
  storePickupAvailable  Boolean @default(false) // Recogida en tienda
  deliveryArea          Json?   // Info libre: zonas, radios, etc.

  // Garant√≠a
  warrantyMonths      Int?    // Ej: 12, 24...
  warrantyType        String? // "Oficial", "Tienda", etc.
  warrantyDescription String? // Detalle de la garant√≠a

  // Campos agregados para buscador / orden / filtros por rese√±as
  ratingAvg   Float @default(0) // rating promedio 0..5
  ratingCount Int   @default(0) // cantidad de rese√±as

  // Atributos extra (talla, material, etc.)
  metadata Json?

  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  categoryId String?

  images         ProductImage[]
  orderItems     OrderItem[]
  stockMovements StockLedger[]
  reviews        ProductReview[]

  // üî• Inversa de wishlist
  wishlistItems WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, createdAt])
  @@index([active, price])
  @@index([active, ratingAvg])
  @@index([categoryId, active, createdAt])
  @@index([brand, active])
  @@index([mainColor, active])
  @@index([productType, active])
  @@index([modelName, active])
}

/**
 * =========================
 * PRODUCT IMAGES
 * =========================
 */
model ProductImage {
  id        String   @id @default(cuid())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  url       String
  publicId  String?  @unique
  alt       String?
  position  Int      @default(0)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([productId, position])
  @@index([productId, isPrimary])
}

/**
 * =========================
 * HOME / LANDING
 * =========================
 * Secciones configurables del home (hero, grids, etc.).
 */
enum HomeSectionType {
  HERO
  PRODUCT_GRID
  PRODUCT_STRIP
  CATEGORY_STRIP
  BANNER
  TEXT_BLOCK
}

model HomeSection {
  id        String          @id @default(cuid())
  slug      String          @unique // identificador estable
  type      HomeSectionType // tipo de secci√≥n
  title     String? // t√≠tulo visible
  subtitle  String? // subt√≠tulo opcional
  config    Json?  // configuraci√≥n (ej. modo, categor√≠a, l√≠mite)
  layout    Json?  // ajustes de layout/estilo
  active    Boolean @default(true) // visible en el home
  position  Int     @default(0)    // orden en el home
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, position, createdAt])
  @@map("home_sections") // usa la misma tabla fisica
}

/**
 * =========================
 * ORDERS
 * =========================
 */
enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  FULFILLED
  PARTIALLY_FULFILLED
  PARTIALLY_REFUNDED
  REFUNDED
  RETURNED
}

model Order {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  userId String

  status   OrderStatus @default(PENDING)
  currency String      @default("usd")

  // Totales (centavos)
  subtotal      Int @default(0)
  discountTotal Int @default(0)
  taxTotal      Int @default(0)
  shippingTotal Int @default(0)
  total         Int

  // Snapshots env√≠o
  emailSnapshot String
  recipientName String
  phone         String?
  addressLine1  String
  addressLine2  String?
  city          String
  state         String?
  postalCode    String
  country       String

  // Facturaci√≥n (opcional)
  billingName       String?
  billingPhone      String?
  billingAddress1   String?
  billingAddress2   String?
  billingCity       String?
  billingState      String?
  billingPostalCode String?
  billingCountry    String?

  shippingAddressJson Json?
  billingAddressJson  Json?

  shippingMethod   String?
  shippingProvider String?
  notes            String?

  items     OrderItem[]
  payment   Payment?
  shipments Shipment[]

  coupons OrderCoupon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model OrderItem {
  id String @id @default(cuid())

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  orderId String

  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  productId String

  quantity       Int
  unitPrice      Int
  currency       String @default("usd")
  taxAmount      Int    @default(0)
  discountAmount Int    @default(0)
  lineTotal      Int    @default(0)

  nameSnapshot     String
  skuSnapshot      String?
  imageUrlSnapshot String?

  @@unique([orderId, productId])
  @@index([orderId])
  @@index([productId])
}

/**
 * =========================
 * COUPONS / DISCOUNTS
 * =========================
 */
enum DiscountType {
  PERCENT // value en basis points (1000 = 10.00%)
  FIXED   // value en centavos
}

model Coupon {
  id          String       @id @default(cuid())
  code        String       @unique
  type        DiscountType
  value       Int
  active      Boolean      @default(true)
  maxUses     Int?
  uses        Int          @default(0)
  minSubtotal Int?
  startsAt    DateTime?
  endsAt      DateTime?

  // Aplica a categor√≠a (opcional)
  appliesToCategoryId String?
  appliesToCategory   Category? @relation("CouponCategoryApplies", fields: [appliesToCategoryId], references: [id], onDelete: SetNull)

  orderCoupons OrderCoupon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, startsAt, endsAt])
}

model OrderCoupon {
  id String @id @default(cuid())

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  orderId String

  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  couponId String

  amountApplied Int

  @@unique([orderId, couponId])
  @@index([orderId])
}

/**
 * =========================
 * PAYMENTS & REFUNDS
 * =========================
 */
model Payment {
  id                      String    @id @default(cuid())
  provider                String
  providerSessionId       String?   @unique
  providerPaymentIntentId String?
  providerCustomerId      String?
  status                  String
  amount                  Int
  currency                String    @default("usd")
  capturedAt              DateTime?
  receiptUrl              String?
  errorCode               String?
  errorMessage            String?
  raw                     Json?

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  orderId String @unique

  refunds Refund[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([provider, providerPaymentIntentId])
}

model Refund {
  id               String   @id @default(cuid())
  payment          Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  paymentId        String
  amount           Int
  status           String
  reason           String?
  providerRefundId String?  @unique
  raw              Json?
  createdAt        DateTime @default(now())

  @@index([paymentId, status])
}

/**
 * =========================
 * SHIPMENTS (env√≠os)
 * =========================
 */
enum ShipmentStatus {
  PENDING
  SHIPPED
  DELIVERED
  RETURNED
  CANCELLED
}

model Shipment {
  id             String         @id @default(cuid())
  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  orderId        String
  status         ShipmentStatus @default(PENDING)
  carrier        String?
  service        String?
  trackingNumber String?
  trackingUrl    String?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime       @default(now())

  @@index([orderId, status, createdAt])
}

/**
 * =========================
 * INVENTORY LEDGER (hist√≥rico)
 * =========================
 */
enum InventoryReason {
  ORDER_PLACED
  ORDER_CANCELLED_RESTORE
  MANUAL_ADJUSTMENT
  REFUND_RETURN
}

model StockLedger {
  id        String          @id @default(cuid())
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productId String
  delta     Int
  reason    InventoryReason
  orderId   String?
  note      String?
  createdAt DateTime        @default(now())

  @@index([productId, createdAt])
}

/**
 * =========================
 * REVIEWS
 * =========================
 */
model ProductReview {
  id String @id @default(cuid())

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String

  rating    Int // valida 1..5 en app
  title     String?
  content   String?
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([productId, userId])
  @@index([productId, approved])
}

/**
 * =========================
 * WISHLIST / FAVORITOS
 * =========================
 */
model WishlistItem {
  id        String   @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  /// Precio del producto (en centavos) cuando el usuario lo a√±adi√≥ a favoritos
  priceAtAdd Int?

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId, createdAt])
  @@index([productId])
}


/**
 * =========================
 * FX (tasas)
 * =========================
 */
model FxRate {
  id          String   @id @default(cuid())
  base        String   // "USD"
  quote       String   // "CUP"
  rate        Decimal  @db.Decimal(10, 4) // ej. 295.50
  source      String   // "informal"
  note        String?  // opcional: "scrape", "manual", etc.
  effectiveAt DateTime @default(now())

  @@index([base, quote, effectiveAt(sort: Desc)])
}

model InformalFx {
  /// C√≥digo de tasa (p.ej. USD, EUR, MLC, CAD, CHF, MXN, CLA, ZELLE)
  code        String   @id
  rate        Float
  source      String?
  effectiveAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/**
 * =========================
 * SUPPORT (chat de atenci√≥n)
 * =========================
 */
enum ConvStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum ConvPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum Channel {
  WEB
  WHATSAPP
  TELEGRAM
  EMAIL
}

// ‚ö†Ô∏è Backend usa "INTERNAL" como √∫nico valor real.
// El FE acepta alias "INTERNAL_NOTE" pero lo normaliza a "INTERNAL" antes de guardar.
enum MsgKind {
  USER
  AGENT
  SYSTEM
  INTERNAL
}

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Cliente (si est√° logueado)
  userId String?
  user   User?   @relation("ConversationUser", fields: [userId], references: [id], onDelete: SetNull)

  // Agente asignado (soporte)
  assignedToId String?
  assignedTo   User?   @relation("AssignedAgent", fields: [assignedToId], references: [id], onDelete: SetNull)

  // Invitado (opcional)
  guestName  String?
  guestEmail String?
  guestKey   String? @unique

  subject  String?
  status   ConvStatus   @default(OPEN)
  channel  Channel      @default(WEB)
  priority ConvPriority @default(NORMAL)

  // üî• Actividad / visto
  lastSeenByCustomerAt DateTime?
  lastSeenByStaffAt    DateTime?

  // üî• M√©tricas / actividad
  lastMessageAt         DateTime?
  lastAgentMessageAt    DateTime?
  lastCustomerMessageAt DateTime?

  // üî• SLA (FRT / resoluci√≥n)
  firstResponseAt    DateTime? // primera respuesta de agente
  resolvedAt         DateTime?
  firstResponseSlaAt DateTime? // deadline 1¬™ respuesta
  resolutionSlaAt    DateTime? // deadline resoluci√≥n

  messages    Message[]
  tags        ConversationTag[]
  attachments Attachment[]

  @@index([status, updatedAt])
  @@index([assignedToId, status])
  @@index([userId, status])
  @@index([status, lastMessageAt])
  @@index([priority, status])
  @@index([firstResponseSlaAt])
  @@index([resolutionSlaAt])
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  authorId String?
  author   User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)

  kind MsgKind @default(USER)
  text String

  attachments Attachment[]
  readAt      DateTime?

  @@index([conversationId, createdAt])
}

model Attachment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  messageId String?
  message   Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  url      String
  mime     String
  size     Int
  publicId String?
  filename String?
  width    Int?
  height   Int?

  @@index([conversationId])
  @@index([messageId])
  @@index([publicId])
}

model ConversationTag {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  tag String

  @@unique([conversationId, tag])
  @@index([tag])
}
